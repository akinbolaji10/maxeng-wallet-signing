<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MaxEng Wallet Signing</title>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column; /* Stack elements vertically */
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #ffffff, #e6f0fa); /* Light gradient */
      color: #000; /* Black text for body */
    }
    h2 {
      margin-bottom: 20px;
      font-size: 36px; /* Larger font to match image */
      font-weight: bold;
      text-align: center;
      color: #000; /* Explicitly black */
    }
    button, #ton-connect button {
      width: 250px; /* Fixed width to match image */
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      border: 2px solid #000; /* Black border */
      border-radius: 8px;
      background: none; /* No background color */
      color: #000 !important; /* Black text, with !important to override potential library styles */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    #ton-connect button {
      position: relative; /* Ensure positioning for pseudo-element */
    }
    #ton-connect button::before {
      content: '▶'; /* Play icon */
      margin-right: 10px;
      font-size: 16px;
      color: #000; /* Black play icon */
    }
    #ton-connect button span {
      display: inline-block; /* Ensure text is visible */
      color: #000 !important; /* Black text, with !important to override potential library styles */
    }
    button:hover, #ton-connect button:hover {
      background: #f0f0f0; /* Light gray on hover */
    }
    /* Override any potential library styles that might change the text color */
    #ton-connect button, #ton-connect button * {
      color: #000 !important;
      cursor: pointer !important;
    }
  </style>
</head>
<body>
  <h2>Connect Your TON Wallet</h2>
  <div id="ton-connect"></div>
  <button id="signBtn">Sign $2 TON Transaction</button>

  <script>
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: window.location.origin + '/tonconnect-manifest.json',
      buttonRootId: 'ton-connect'
    });

    let tonPrice = null;

    // Function to apply custom styles to the TON Connect button
    function applyButtonStyles() {
      const tonConnectButton = document.querySelector('#ton-connect button');
      if (tonConnectButton) {
        tonConnectButton.innerHTML = '<span style="color: #000 !important;">Connect Wallet</span>';
        tonConnectButton.style.color = '#000';
        tonConnectButton.style.cursor = 'pointer';
      }
    }

    // Apply styles after the library initializes
    tonConnectUI.onStatusChange((wallet) => {
      applyButtonStyles(); // Reapply styles whenever the wallet status changes
    });

    // Initial application of styles after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      applyButtonStyles();
    });

    async function getTonPriceUSD() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=toncoin&vs_currencies=usd');
        console.log('Fetch response:', res);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        console.log('Fetched data:', data);
        if (!data || !data.toncoin || !data.toncoin.usd) {
          throw new Error('Invalid data structure received from CoinGecko.');
        }
        return data.toncoin.usd;
      } catch (err) {
        console.error('Failed to fetch TON price:', err);
        return null;
      }
    }

    async function updatePrice() {
      tonPrice = await getTonPriceUSD();
      if (tonPrice) {
        const tonAmount = (2 / tonPrice).toFixed(4);
        console.log(`Live price: $${tonPrice} → ~${tonAmount} TON for $2`);
      } else {
        console.log('⚠ Failed to load live price. Please refresh or check your internet connection.');
      }
    }

    updatePrice();

    document.getElementById('signBtn').addEventListener('click', async () => {
      const walletInfo = await tonConnectUI.getWallet();
      if (!walletInfo) {
        console.log('⚠ Please connect your wallet first.');
        return;
      }
      if (!tonPrice) {
        console.log('⚠ Live price unavailable. Please refresh.');
        return;
      }
      const amountNano = (2 / tonPrice * 1e9).toFixed(0);
      try {
        await tonConnectUI.sendTransaction({
          validUntil: Math.floor(Date.now() / 1000) + 360,
          messages: [{
            address: 'UQBP1Ue44jVdu1Zc1sOFzsVnpnOZPFIzfA4eMCvjbpFd50bN',
            amount: amountNano
          }],
        });
        console.log('✅ Transaction request sent to your wallet!');
      } catch (err) {
        console.error(err);
        console.log('❌ Transaction failed or cancelled.');
      }
    });
  </script>
</body>
</html>
